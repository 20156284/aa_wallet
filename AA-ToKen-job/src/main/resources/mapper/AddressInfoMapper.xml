<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.wallet.job.mapper.AddressInfoMapper">
    <insert id="addAddress">
        INSERT INTO tb_address_${protocol}
        SET address=#{address}, protocol=#{protocol}
    </insert>
    <select id="getAddressCount" resultType="java.lang.Integer">
        SELECT id
        FROM tb_address_${protocol}
        WHERE address = #{address}
    </select>
    <update id="updateAddress">
        UPDATE tb_address_${protocol}
        SET status=1
        WHERE id = #{id}
    </update>
    <update id="deleteAddress">
        UPDATE tb_address_${protocol}
        SET status=2
        WHERE address = #{address}
    </update>
    <select id="transactionRecords" resultType="java.util.Map">
        SELECT transfer_type AS transferType,coin_key AS coinKey,
        from_address AS fromAddress,to_address AS toAddress,
        qty as number,tx_id as txId,protocol,status,tx_fee AS txFee FROM
        tb_wallet_transfer_record_${protocol} WHERE 1=1
        <choose>
            <when test="type != null">
                AND transfer_type=#{type}
            </when>
            <otherwise>
                AND (transfer_type=10 OR transfer_type=20)
            </otherwise>
        </choose>
    </select>

    <select id="getBlockScanner" resultType="java.util.Map">
        SELECT id, protocol, block_height, locked
        FROM tb_wallet_block_scanner
        WHERE protocol = #{protocol}
    </select>

    <select id="getContractAddress" resultType="java.util.Map">
        SELECT contract_address, coin_key
        FROM tb_wallet_contract_address
        WHERE protocol = #{protocol}
          AND contract_address = #{contractAddress}
    </select>

    <select id="countAddress" resultType="java.util.Map">
        SELECT address
        FROM tb_address_${protocol}
        WHERE protocol = #{protocol}
          AND (address = #{fromAddress} OR address = #{toAddress})
    </select>

    <select id="getHash" resultType="java.lang.Integer">
        SELECT count(id)
        FROM tb_wallet_transfer_record_${protocol}
        WHERE tx_id = #{hash}
          AND transfer_type = #{type}
    </select>

    <insert id="insertWalletTransfer">
        INSERT INTO tb_wallet_transfer_record_${protocol}
        SET transfer_type=#{transferType}, coin_type=#{coinKey},
            from_address=#{fromAddress}, to_address=#{toAddress},
            qty=#{amount}, tx_id = #{txId}, protocol=#{protocol},
            tx_fee=#{txFee}, status = #{status}

    </insert>

    <update id="updateBlockScanner">
        UPDATE tb_wallet_block_scanner
        SET block_height=#{blockHeight}
        WHERE id = #{id}
    </update>

    <insert id="addBlockScanner">
        INSERT INTO tb_wallet_block_scanner
        SET protocol = #{protocol}, block_hash=#{blockHash}, block_height=#{blockHeight}
    </insert>
</mapper>
